(If you have trouble using this page, you can
<a href="?view=plain">switch to the plain HTML form</a>.)

<p>
<script src="/static/prototype.js" type="text/javascript"></script>
<script language="JavaScript">
// <![CDATA[

function save(id, parameters) {
  style = "font-family: sans-serif; font-size: smaller; " +
          "color:white; background:red;";
  if (status = $(id + 'Status'))
    status.setStyle(style).update("Saving...");
  new Ajax.Updater(id + 'Status', '/ajax/',
                   { parameters: parameters });
}

function saveBallot(id) {
  save(id, { field: id, value: $F(id) });
}

function saveVote(category, rank, field) {
  id = category + rank + field;
  save(id, { category: category, rank: rank, field: field, value: $F(id) });
}

function makeVoteFields(category, vote) {
  prefix = category + vote.rank;
  artist = new Element('input', {
    id: prefix + "artist", size: 20, value: vote.artist,
    onchange: "saveVote('" + category + "', " + vote.rank + ", 'artist')",
  });
  title = new Element('input', {
    id: prefix + "title", size: 40, value: vote.title,
    onchange: "saveVote('" + category + "', " + vote.rank + ", 'title')",
  });
  comments = new Element('textarea', {
    id: prefix + "comments", rows: 2, cols: 90,
    onchange: "saveVote('" + category + "', " + vote.rank + ", 'comments')",
  }).insert(vote.comments);
  return new Element('div').insert(vote.rank + ". Artist: ").insert(artist)
    .insert(" Title: ").insert(title).insert(new Element('br'))
    .insert(comments).insert(new Element('br'));
}

function addVote(category) {
  save("add" + category, { field: "add", category: category });
  vote = { rank: votes[category].length + 1,
           artist: "", title: "", comments: "" };
  votes[category].push(vote);
  $(category).insert(makeVoteFields(category, vote));
}

function addVotes(n, category) {
  for (i = 0; i < n; i++) addVote(category);
}

// ]]>
</script>

<form action="." method="post">
  Opening comments: <span id="preambleStatus"></span><br>
  <textarea name="preamble" id="preamble"
	    onchange="javascript:saveBallot('preamble')"
	    rows="4" cols="90">{{ ballot.preamble|escape }}</textarea><br><br>

  <div id="vote"></div>

  <a name="mention"></a>
  <br>Honorable mentions:<br>
  <div id="mention"></div>
  <br>
  <input type="button" value="Add honorable mentions..."
	  onclick="addVotes(10, 'mention')">
  <br>

  <a name="note"></a>
  <br>Other notable releases:<br>
  <div id="note"></div>
  <br>
  <input type="button" value="Add other notable releases..."
	  onclick="addVotes(10, 'note')">
  <br>

  <br>Closing comments: <span id="postambleStatus"></span><br>
  <textarea name="postamble" id="postamble"
	    onchange="javascript:saveBallot('postamble')"
	    rows="4" cols="90">{{ ballot.postamble|escape }}</textarea><br>
  <br>
  Anonymous:
  <input type="checkbox" name="anonymous" id="anonymous"
	 {% if ballot.anonymous %} checked {% endif %}
	 onclick="javascript:saveBallot('anonymous')">
  <span id="anonymousStatus"></span>
</form>

<script language="JavaScript">
// <![CDATA[

votes = {{ votes }};

for (category in votes)
  for (i = 0; i < votes[category].length; i++)
    $(category).insert(makeVoteFields(category, votes[category][i]));

// ]]>
</script>
