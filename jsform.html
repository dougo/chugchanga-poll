(If you have trouble using this page, you can
<a href="?view=plain">switch to the plain HTML form</a>.)

<p>
<script src="/static/prototype.js" type="text/javascript"></script>
<script language="JavaScript">
// <![CDATA[

function save(id, parameters) {
  style = "font-family: sans-serif; font-size: smaller; " +
          "color:white; background:red;";
  if (status = $(id + 'Status'))
    status.setStyle(style).update("Saving...");
  new Ajax.Updater(id + 'Status', '/ajax/',
                   { parameters: parameters });
}

function saveBallot(id) {
  save(id, { field: id, value: $F(id) });
}

function saveVote(category, rank, field) {
  id = category + rank + field;
  save(id, { category: category, rank: rank, field: field, value: $F(id) });
}

function makeVoteFields(category, vote) {
  prefix = category + vote.rank;
  artist = new Element('input', {
    id: prefix + "artist", size: 20, value: vote.artist,
    onchange: "saveVote('" + category + "', " + vote.rank + ", 'artist')",
  });
  title = new Element('input', {
    id: prefix + "title", size: 40, value: vote.title,
    onchange: "saveVote('" + category + "', " + vote.rank + ", 'title')",
  });
  comments = new Element('textarea', {
    id: prefix + "comments", rows: 2, cols: 90,
    onchange: "saveVote('" + category + "', " + vote.rank + ", 'comments')",
  }).insert(vote.comments);
  return new Element('div').insert(vote.rank + ". Artist: ").insert(artist)
    .insert(" Title: ").insert(title).insert(new Element('br'))
    .insert(comments).insert(new Element('br'));
}

function addVote(category) {
  vote = { rank: votes[category].length + 1,
           artist: "", title: "", comments: "" };
  votes[category].push(vote);
  fields = makeVoteFields(category, vote);
  fields.setAttribute("onkeypress", "addVote('" + category +
                                    "'); this.removeAttribute('onkeypress')");
  $(category).insert(fields);
}

function addVotes(n, category) {
  for (i = 0; i < n; i++) addVote(category);
}

// ]]>
</script>

<form action="." method="post">
  <br><a name="preamble"></a>
  <h3>Opening comments <span id="preambleStatus"></span></h3>
  <textarea name="preamble" id="preamble"
	    onchange="javascript:saveBallot('preamble')"
	    rows="4" cols="90">{{ ballot.preamble|escape }}</textarea>
  <br>

  <br><a name="favorite"></a>
  <h3>Favorite releases</h3>
  <div id="favorite"></div>

  <br><a name="honorable"></a>
  <h3>Honorable mentions</h3>
  <div id="honorable"></div>

  <br><a name="notable"></a>
  <h3>Other notable releases</h3>
  <div id="notable"></div>

  <br><a name="postamble"></a>
  <h3>Closing comments <span id="postambleStatus"></span></h3>
  <textarea name="postamble" id="postamble"
	    onchange="javascript:saveBallot('postamble')"
	    rows="4" cols="90">{{ ballot.postamble|escape }}</textarea><br>
  <br>
  Anonymous:
  <input type="checkbox" name="anonymous" id="anonymous"
	 {% if ballot.anonymous %} checked {% endif %}
	 onclick="javascript:saveBallot('anonymous')">
  <span id="anonymousStatus"></span>
</form>

<script language="JavaScript">
// <![CDATA[

votes = {{ votes }};

for (category in votes) {
  voteList = votes[category];
  voteArray = new Array();
  for (i = 0; i < voteList.length; i++) {
    vote = voteList[i];
    voteArray[vote.rank-1] = vote;
  }
  // Fill the gaps in the ranking with empty votes.
  for (i = 0; i < voteArray.length; i++) {
    if (!voteArray[i])
      voteArray[i] = { rank: i+1, artist: "", title: "", comments: "" };
    $(category).insert(makeVoteFields(category, voteArray[i]));
  }
  votes[category] = voteArray;
  if (!(category == "favorite" && voteArray.length == 20))
    // Add a blank vote at the end.
    addVote(category);
}

// ]]>
</script>
